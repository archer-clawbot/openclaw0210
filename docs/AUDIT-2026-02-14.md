# OpenClaw System Audit — 2026-02-14

## Overview

Full security, resilience, and code quality audit of the OpenClaw 18-agent orchestration system. Identified 52 findings across CRITICAL/HIGH/MEDIUM/LOW severities, implemented fixes in 5 phases (P0-P4), shipped incrementally with Convex deployments and PM2 restarts between each phase.

**Scope:** `cron/` dispatcher runtime, `mission-control/convex/` backend, `cron/lib/` shared modules, credential hygiene across entire repo.

**Production target:** `valuable-partridge-851.convex.cloud`

---

## Git History

| Phase | Commit | Hash | Date |
|-------|--------|------|------|
| P0 | `fix(security): Phase 0 — stop-the-bleeding audit fixes` | `4cf7269` | 2026-02-14 |
| P1 | `security(P1): purge hardcoded credentials from tracked files` | `6880a9f` | 2026-02-14 |
| P2 | `feat(resilience): Phase 2 — retry, breaker fix, backfill fix` | `babf8d9` | 2026-02-14 |
| P3 | `feat(hardening): Phase 3 — validation, constants, dead letter route` | `68172cc` | 2026-02-14 |
| P4 | `fix(reliability): Phase 4 — breaker probes, reconnect backoff, sanitizer hardening` | `fce2c40` | 2026-02-14 |

**Total impact:** 68 files changed, 424 insertions, 3,911 deletions.

---

## Phase 0 — Security Stop-the-Bleeding

**Priority:** CRITICAL — unauthenticated routes, open webhook bypass, missing timeouts, race condition.

### P0-1: Bearer Token Auth on All HTTP Routes

**File:** `mission-control/convex/http.ts`

**Problem:** All 8 dispatcher HTTP routes (`/dispatcher/tasks/*`) were completely unauthenticated. Anyone with the Convex site URL could query, create, modify, or delete tasks.

**Fix:** Added `verifyApiToken()` middleware and `authedHandler()` wrapper function. Every dispatcher route now:
1. Extracts `Authorization: Bearer <token>` from request headers
2. SHA-256 hashes the raw token
3. Looks up the hash in the `apiTokens` table via `verifyToken` query
4. Returns 401 (missing header), 403 (invalid/revoked token), or passes through
5. Fire-and-forget updates `lastUsedAt` via `touchToken` mutation

The WooCommerce webhook route (`/woo/webhook`) was left unchanged — it uses its own HMAC-SHA256 signature verification.

### P0-2: Webhook Signature Bypass Fix

**File:** `mission-control/convex/wooWebhook.ts`

**Problem:** When `WC_WEBHOOK_SECRET` environment variable was not set, the webhook verification function returned `true` (allow all), effectively disabling HMAC verification. Any HTTP request to `/woo/webhook` would be accepted.

**Fix:** Changed the missing-secret fallback from `return true` to `return false`. Changed `console.warn` to `console.error`. Now if the secret isn't configured, all webhooks are rejected rather than blindly accepted.

### P0-3: Timeouts on Async Calls

**Files:** `cron/lib/gateway.js`, `cron/lib/convex.js`, `cron/lib/bridge.js`, `cron/dispatcher.js`

**Problem:** Multiple async operations had no timeout protection:
- `convex.js` fetch calls could hang indefinitely if Convex was unresponsive
- `bridge.js` HMAC-signed requests to WordPress had no timeout
- `gateway.js` WebSocket request/response pairs had no timeout — if the gateway never responded, the promise would leak forever
- `dispatcher.js` `WAIT_TIMEOUT` was only 3 seconds, causing premature timeouts on normal operations

**Fixes:**
- `convex.js`: Added `AbortSignal.timeout(15_000)` to all fetch calls
- `bridge.js`: Added `AbortSignal.timeout(15_000)` to fetch calls
- `gateway.js`: Added 30-second timeout to `_request()` method with auto-cleanup of pending request map entries
- `dispatcher.js`: Increased `WAIT_TIMEOUT` from 3,000ms to 10,000ms

### P0-4: Deliverable Race Condition Fix

**File:** `mission-control/convex/dispatcher.ts`

**Problem:** In the `complete` mutation, when a task linked to a deliverable completed, the code was setting `emailSentAt: Date.now()` on the deliverable. But the email was scheduled via `ctx.scheduler.runAfter(0, ...)` — it's asynchronous and hasn't been sent yet at that point. The timestamp was misleading.

**Fix:** Removed the premature `emailSentAt` field from the deliverable patch. Email sending now correctly uses the scheduler without claiming it was already sent. Also replaced a `Record<string, unknown>` type with properly typed branches for the deliverable patch.

---

## Phase 1 — Credential Hygiene

**Priority:** HIGH — plaintext WordPress app passwords scattered across tracked files.

### What was found

A sweep of the entire repo found hardcoded WordPress app passwords in:
- **43 temp scripts** (`temp_*.py`, `temp_*.ps1`) — one-off deployment/debug scripts that embedded `WP_APP_PASSWORD` values in curl commands and Python requests
- **8 workspace scripts** (`workspace/*.py`) — page-fixing and content-deployment scripts with embedded credentials
- **4 archived session JSONL files** — agent conversation logs that contained credentials from tool calls
- **1 deliverable markdown** — `deliverables/localcatalyst/wrench/2026-02-12-faq-hover-fix-sitewide.md` had a real password in a curl example
- **1 skills doc** — `workspace/skills/wordpress-dev-best-practices.md` had real password examples

### What was done

1. **Deleted 55 files** — all temp scripts, workspace scripts, and archived sessions containing credentials
2. **Redacted 2 files** — replaced real passwords with env var references (`os.environ['WP_APP_PASSWORD']`)
3. **Updated `.gitignore`** — added patterns to prevent future commits:
   - `temp_*.py` and `temp_*.ps1`
   - `agents/*/sessions/_archived/`

### Password Rotation Assessment

Checked `.env` and `cron/clients/*.json` for WordPress app passwords that need rotation:
- `WP_LOCALCATALYST_APP_PASSWORD` — active, used by dispatcher for LocalCatalyst site
- `WP_CHICAGOS_ELECTRICIAN_APP_PASSWORD` — active, used by dispatcher for Chicago's Electrician site
- `darkgreen-moose-683278` site — confirmed no longer exists (migrated to new host), no rotation needed

**Action for user:** Rotate the two active WordPress app passwords through each site's wp-admin > Users > Application Passwords panel, then update `.env` with new values.

---

## Phase 2 — Resilience

**Priority:** HIGH — no retry logic, broken circuit breaker recovery, stale concurrency counts.

### P2-1: Retry with Exponential Backoff

**File:** `cron/lib/convex.js`

**Problem:** All Convex HTTP calls were fire-once. A single transient 500 or network timeout would fail the entire operation, potentially leaving tasks in inconsistent states.

**Fix:** Rewrote `convexFetch()` with:
- 3 retry attempts
- 500ms base delay with exponential backoff (500ms, 1s, 2s) plus random jitter (0-200ms)
- Only retries on transient errors: HTTP 5xx, 429 (rate limit), `TimeoutError`, `AbortError`
- 4xx client errors (except 429) fail immediately without retry
- Response text is read before status check for better error diagnostics
- Detects Convex-style `{error: ...}` responses even with 200 status

### P2-2: Circuit Breaker `probeResult()` Function

**File:** `cron/lib/breakers.js`

**Problem:** The circuit breaker had CLOSED, OPEN, and HALF_OPEN states, but no way to report the result of a HALF_OPEN probe. When `check()` transitioned a breaker from OPEN to HALF_OPEN (after cooldown), the probe task would be dispatched, but the result was never fed back to the breaker. The breaker would stay in HALF_OPEN indefinitely.

**Fix:** Added `probeResult(agentId, success, log)` function:
- If `success === true` and breaker is HALF_OPEN: transitions to CLOSED (clears trippedAt and reason)
- If `success === false` and breaker is HALF_OPEN: transitions back to OPEN with new timestamp and "probe failed" reason
- No-op if breaker is not in HALF_OPEN state (safe to call on every task completion)
- Added to `module.exports`

**Note:** The actual wiring of `probeResult()` into the dispatcher was done in Phase 4 (P4-1).

### P2-3: Dead Letter Queue — `retryBlocked` Mutation

**File:** `mission-control/convex/dispatcher.ts`

**Problem:** When a task exhausted all retry attempts, it was moved to `status: "review"` with a `"blocked"` tag. There was no way to reset it for another round of attempts — it was effectively dead-lettered with no recovery path.

**Fix:** Added `retryBlocked` mutation:
- Validates task exists and belongs to the specified tenant
- Checks task is in `status: "review"` with `"blocked"` tag
- Resets `attempts` to 0, clears `lastError`, removes `"blocked"` tag, moves to `status: "assigned"`
- Returns `{ ok: true }` on success or `{ ok: false, reason: "..." }` if not in blocked state

**Note:** The HTTP route for this mutation was added in Phase 3 (P3-5).

### P2-4: Windows Path Separator Fix

**File:** `cron/dispatcher.js` (line 136)

**Problem:** Deliverable save path was built with hardcoded `\\` separator: `` `${deliverables}\\` ``. This would fail on any non-Windows platform.

**Fix:** Changed to `${deliverables}${path.sep}` using Node's cross-platform `path.sep`.

### P2-5: Stale `activeCount` in Backfill Logic

**File:** `cron/dispatcher.js` (line 323)

**Problem:** The backfill calculation at the end of `pollClient()` computed `activeCount` as `inProgressTasks.length - completed`, but didn't account for newly dispatched tasks in the same cycle. This meant if 2 tasks were dispatched and 0 completed, the backfill would over-promote because it didn't count the 2 new dispatches.

**Fix:** Changed to `inProgressTasks.length - completed + dispatched` to include tasks dispatched during the current cycle.

---

## Phase 3 — Validation & Constants

**Priority:** MEDIUM — missing input validation, hardcoded magic numbers, dead mutation.

### P3-1: Environment Variable Startup Validation

**File:** `cron/dispatcher.js`

**Problem:** The dispatcher would start and run even if critical environment variables were missing. It would only fail later with cryptic errors (e.g., `fetch` to `undefined/dispatcher/tasks/query`).

**Fix:** Added `validateEnv()` function called at the top of `main()`:
- Checks for `CONVEX_SITE_URL`, `CONVEX_API_TOKEN`, `GATEWAY_AUTH_TOKEN`
- Prints `FATAL: Missing required env vars: ...` and exits with code 1 if any are missing
- Runs before any CLI flag processing, so even `--status` or `--breakers` commands require valid env

### P3-2: Input Validation on Convex Dispatcher Mutations

**File:** `mission-control/convex/dispatcher.ts`

**Problem:** Mutations accepted any values without validation. A malicious or buggy caller could:
- Create a task with a 10MB title or description
- Set `maxAttempts` to -1 or 999999
- Set an invalid status like `"banana"`
- Record negative token counts or costs

**Fix:** Added validation constants and guards:

```
VALID_STATUSES = ["inbox", "assigned", "in_progress", "review", "done", "archived"]
VALID_PRIORITIES = ["low", "medium", "high", "urgent"]
MAX_TITLE_LENGTH = 500
MAX_DESCRIPTION_LENGTH = 50,000
MAX_ATTEMPTS_LIMIT = 10
```

- `createTask`: validates title length, description length, status enum, priority enum, maxAttempts range (1-10)
- `recordUsage`: validates inputTokens, outputTokens, totalCost, cacheReadTokens, cacheWriteTokens are all non-negative
- `promote`: validates fromStatus and toStatus against enum, limit must be >= 1

### P3-3: Client Config Structure Validation

**File:** `cron/lib/clients.js`

**Problem:** `listActive()` loaded client JSON configs and only caught JSON parse errors. If a config was valid JSON but missing required fields (e.g., no `domain` or `tenantId`), it would be loaded and used, causing failures deep in the dispatcher with unhelpful error messages.

**Fix:** Added `validate(config, slug)` function that checks:
- Required fields: `name`, `domain`, `tenantId`, `status`
- If `access.wordpress` exists: requires `url`, `restApi`, `user`, `appPassword`
- If `maxConcurrent` exists: must be a positive number

`listActive()` now validates each config before including it. Invalid configs log a warning with specific error details and are **skipped** rather than loaded.

### P3-4: Extract Hardcoded Timeouts to Named Constants

**Files:** `cron/lib/convex.js`, `cron/lib/bridge.js`, `cron/lib/gateway.js`

**Problem:** Timeout values were hardcoded inline as magic numbers (`15_000`, `30_000`), making them hard to find and tune.

**Fix:**
- `convex.js`: Added `HTTP_TIMEOUT_MS = 15_000` constant, replaced inline `15_000`
- `bridge.js`: Added `HTTP_TIMEOUT_MS = 15_000` constant, replaced inline `15_000`
- `gateway.js`: Added `GW_REQUEST_TIMEOUT_MS = 30_000` constant, replaced inline `30_000` in `_request()` default parameter

### P3-5: Wire `retryBlocked` Route into HTTP Layer

**File:** `mission-control/convex/http.ts`

**Problem:** The `retryBlocked` mutation (added in P2-3) was exported from `dispatcher.ts` but had no HTTP route — it was unreachable from the dispatcher or any external caller.

**Fix:** Added authenticated route:
```
POST /dispatcher/tasks/retry-blocked
Body: { taskId, tenantId }
Auth: Bearer token (same middleware as all other routes)
```

---

## Phase 4 — Reliability & Defense

**Priority:** MEDIUM — broken state machine, reconnect spam, injection defense gap.

### P4-1: Wire `probeResult()` into Dispatcher Loop

**File:** `cron/dispatcher.js`

**Problem:** The `probeResult()` function was added to `breakers.js` in Phase 2, but never called from the dispatcher. The circuit breaker's HALF_OPEN state machine was effectively broken — probes would dispatch but the result was never reported, so the breaker stayed in HALF_OPEN forever.

**Fix:** Added two `breakers.probeResult()` calls in the `waitForAgent` result handling section:
- After `result.status === 'ok'` (task completed): `breakers.probeResult(task.agentId, true, log)` — transitions HALF_OPEN to CLOSED
- After `result.status === 'error'` (task failed): `breakers.probeResult(task.agentId, false, log)` — transitions HALF_OPEN back to OPEN

Both calls are no-ops if the breaker isn't in HALF_OPEN state, so they're safe to call on every task completion/failure without checking breaker state first.

### P4-2: Gateway Reconnect Exponential Backoff

**File:** `cron/lib/gateway.js`

**Problem:** When the gateway WebSocket connection dropped, the client reconnected after a fixed 5-second delay. If the gateway was down or rejecting auth, this created an infinite loop of reconnect attempts every 5 seconds, spamming logs and wasting resources.

**Fix:**
- Added `RECONNECT_MAX_DELAY = 60_000` constant (60-second cap)
- Added `_reconnectDelay` instance variable, initialized to `RECONNECT_DELAY` (5s)
- `_scheduleReconnect()` now:
  - Uses `this._reconnectDelay` instead of fixed `RECONNECT_DELAY`
  - On successful reconnect (`.then()`): resets delay back to 5s
  - On failed reconnect (`.catch()`): doubles delay, capped at 60s
  - Logs the actual delay being used (e.g., `[gw] reconnecting in 10.0s...`)

Backoff sequence: 5s, 10s, 20s, 40s, 60s, 60s, 60s...

### P4-3: Sanitizer Delimiter Escape Detection

**File:** `cron/lib/sanitizer.js`

**Problem:** Two gaps in the prompt injection defense:

1. **No delimiter escape detection:** The sanitizer wraps external content in `--- EXTERNAL CONTENT START ---` / `--- EXTERNAL CONTENT END ---` delimiters. But if the content itself contained those exact strings, it could "break out" of the delimiter sandbox and inject instructions that appear to be outside the external content boundary.

2. **No detection of common LLM delimiter patterns:** Strings like `[/INST]`, `[/SYS]`, `<<SYS>>`, `--- SYSTEM START ---` etc. could be used to manipulate prompt structure.

**Fix:**
- Added `delimiter_escape` pattern group to `INJECTION_PATTERNS` (severity 9):
  - Catches `--- EXTERNAL CONTENT START/END ---`
  - Catches `--- SYSTEM/INSTRUCTIONS/CONTEXT START/END/BOUNDARY ---`
  - Catches `[/INST]`, `[/SYS]`
  - Catches `<<SYS>>`, `<<INST>>`, `<<END>>`
- Updated `wrapContent()` to escape delimiter strings in content before wrapping (replaces `---` with `--` around delimiter keywords)

---

## Files Modified — Complete List

### Phase 0
| File | Change |
|------|--------|
| `mission-control/convex/http.ts` | Complete rewrite — added auth middleware, authedHandler wrapper |
| `mission-control/convex/wooWebhook.ts` | Changed bypass from `return true` to `return false` |
| `mission-control/convex/dispatcher.ts` | Removed premature emailSentAt, typed patch branches |
| `cron/lib/gateway.js` | Added 30s timeout to `_request()` |
| `cron/lib/convex.js` | Added `AbortSignal.timeout(15_000)` |
| `cron/lib/bridge.js` | Added `AbortSignal.timeout(15_000)` |
| `cron/dispatcher.js` | Changed WAIT_TIMEOUT from 3,000 to 10,000 |

### Phase 1
| File | Change |
|------|--------|
| 43 `temp_*.py/ps1` files | Deleted (hardcoded credentials) |
| 8 `workspace/*.py` files | Deleted (hardcoded credentials) |
| 4 archived session `.jsonl` files | Deleted (contained credentials in tool calls) |
| `workspace/skills/wordpress-dev-best-practices.md` | Replaced real password with env var example |
| `deliverables/.../2026-02-12-faq-hover-fix-sitewide.md` | Redacted password |
| `.gitignore` | Added `temp_*.py`, `temp_*.ps1`, `agents/*/sessions/_archived/` |

### Phase 2
| File | Change |
|------|--------|
| `cron/lib/convex.js` | Complete rewrite with retry + exponential backoff |
| `cron/lib/breakers.js` | Added `probeResult()` for HALF_OPEN state management |
| `mission-control/convex/dispatcher.ts` | Added `retryBlocked` mutation |
| `cron/dispatcher.js` | Fixed path separator (path.sep), fixed activeCount calculation |

### Phase 3
| File | Change |
|------|--------|
| `cron/dispatcher.js` | Added `validateEnv()` startup check |
| `mission-control/convex/dispatcher.ts` | Added input validation to createTask, recordUsage, promote |
| `cron/lib/clients.js` | Added `validate()` function, validation in `listActive()` |
| `cron/lib/convex.js` | Extracted `HTTP_TIMEOUT_MS` constant |
| `cron/lib/bridge.js` | Extracted `HTTP_TIMEOUT_MS` constant |
| `cron/lib/gateway.js` | Extracted `GW_REQUEST_TIMEOUT_MS` constant |
| `mission-control/convex/http.ts` | Added `/dispatcher/tasks/retry-blocked` route |

### Phase 4
| File | Change |
|------|--------|
| `cron/dispatcher.js` | Wired `breakers.probeResult()` into waitForAgent result handling |
| `cron/lib/gateway.js` | Added exponential backoff to reconnect (5s-60s) |
| `cron/lib/sanitizer.js` | Added delimiter_escape pattern, escape in wrapContent() |

---

## Architecture Notes

### Circuit Breaker State Machine (now fully functional)

```
CLOSED ──(cost threshold exceeded)──> OPEN
   ^                                    |
   |                              (cooldown expires)
   |                                    v
   └──(probe succeeds)──── HALF_OPEN ──(probe fails)──> OPEN
```

- `breakers.check(agentId, log)` — called before dispatch, returns `{allowed, state, reason}`
- `breakers.probeResult(agentId, success, log)` — called after task completion, transitions HALF_OPEN
- `breakers.trip(agentId, reason)` — manually trip a breaker
- `breakers.reset(agentId)` / `breakers.resetAll()` — manual recovery
- CLI: `node dispatcher.js --breakers` to view state, `--breaker-reset <id|all>` to reset

### Retry Strategy

```
Convex HTTP calls:  3 attempts, 500ms base, exponential backoff + jitter
                    Retries: 5xx, 429, TimeoutError, AbortError
                    No retry: 4xx (except 429)

Gateway reconnect:  Exponential backoff 5s → 60s cap
                    Resets to 5s on successful reconnect

Bridge HTTP calls:  No retry (single attempt, 15s timeout)
                    Errors thrown to caller for handling
```

### Auth Flow

```
Dispatcher → Convex HTTP:  Bearer token (SHA-256 hashed, stored in apiTokens table)
WooCommerce → Convex:      HMAC-SHA256 webhook signature (WC_WEBHOOK_SECRET)
Dispatcher → WordPress:    HMAC-SHA256 signed requests (OPENCLAW_BRIDGE_SECRET)
Dispatcher → Gateway WS:   Token in handshake params (GATEWAY_AUTH_TOKEN)
```

### Input Validation Boundaries

```
WooCommerce webhook → wooWebhook.ts (HMAC verified)
                   → dispatcher.ts createTask (title/desc length, status/priority enum, maxAttempts range)
                   → dispatcher.js sanitizeTask (injection pattern detection, zero-width strip)
                   → buildTaskMessage (credential gating, awareness injection)

Client configs     → clients.js validate() (required fields, WordPress access fields, maxConcurrent type)
Environment vars   → dispatcher.js validateEnv() (CONVEX_SITE_URL, CONVEX_API_TOKEN, GATEWAY_AUTH_TOKEN)
```

---

## Known Remaining Items (not addressed)

These were identified during the audit but deferred as low priority or out of scope:

1. **WooCommerce webhook pre-sanitization** — Product names from WooCommerce flow into task titles without sanitization at ingestion time. They are sanitized at dispatch time by `sanitizeTask()`, but malicious content sits in the database between ingestion and dispatch. Low risk since the webhook itself is HMAC-authenticated.

2. **Log rotation file locking** — `rotateLog()` in dispatcher.js has no file locking. If PM2 restarts during rotation, a log line could theoretically be lost. Low risk since PM2 runs a single instance and rotation is fast (sync rename operations).

3. **bridge.js unused exports** — All exported functions (`getSubscriptionStatus`, `getAllActiveSubscriptions`, `reportFleetHealth`, `verifyBridge`, `fulfillOrder`) are implemented but not yet called by the dispatcher. This is IMPL-003 infrastructure built for future subscription management integration.

4. **compressor.js MemoryManager class** — Fully defined class that's never instantiated. Appears to be future work for context window management. Only `formatStatus()` is used (via `--memory` CLI flag).

5. **Homoglyph/Unicode lookalike detection** — Sanitizer doesn't detect Cyrillic/Greek characters mixed with Latin that could bypass regex patterns (e.g., Cyrillic "i" in "ignore"). Edge case requiring Unicode normalization.

6. **PM2 watch mode** — `ecosystem.config.js` has file watching enabled, which could cause unexpected restarts during deployment. Consider making conditional based on `NODE_ENV`.
