"<?php\n/**\n * Plugin Name: OpenClaw Fleet Bridge\n * Description: Authenticated REST API bridge between OpenClaw fleet and WordPress/WooCommerce.\n * Version: 1.0.0\n * Author: OpenClaw / Spartan Digital\n * Requires at least: 6.0\n */\n\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n// \u2500\u2500\u2500 CONFIG \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n// Shared secret for HMAC-SHA256 request signing.\n// Set in wp-config.php: define('OPENCLAW_BRIDGE_SECRET', 'your-64-char-hex-string');\n// Generate with: openssl rand -hex 32\nif (!defined('OPENCLAW_BRIDGE_SECRET')) {\n    // Fail loudly if not configured \u2014 don't silently operate without auth\n    add_action('admin_notices', function () {\n        echo '<div class=\"error\"><p><strong>OpenClaw Bridge:</strong> OPENCLAW_BRIDGE_SECRET is not defined in wp-config.php. Bridge endpoints are disabled.</p></div>';\n    });\n    return; // Don't register any endpoints\n}\n\ndefine('OPENCLAW_BRIDGE_VERSION', '1.0.0');\ndefine('OPENCLAW_BRIDGE_TIMESTAMP_TOLERANCE', 300); // 5 minutes\ndefine('OPENCLAW_BRIDGE_NAMESPACE', 'openclaw/v1');\n\n// \u2500\u2500\u2500 HMAC AUTHENTICATION \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/**\n * Verify HMAC-SHA256 signature on incoming requests.\n *\n * Expected headers:\n *   X-OpenClaw-Timestamp: Unix timestamp (seconds)\n *   X-OpenClaw-Signature: HMAC-SHA256 hex digest\n *\n * Signature covers: timestamp + \":\" + HTTP_METHOD + \":\" + request_path + \":\" + sha256(body)\n */\nfunction openclaw_verify_hmac(WP_REST_Request $request) {\n    $timestamp = $request->get_header('X-OpenClaw-Timestamp');\n    $signature = $request->get_header('X-OpenClaw-Signature');\n\n    if (!$timestamp || !$signature) {\n        return new WP_Error(\n            'openclaw_missing_auth',\n            'Missing X-OpenClaw-Timestamp or X-OpenClaw-Signature header.',\n            ['status' => 401]\n        );\n    }\n\n    // Replay protection \u2014 reject requests older than 5 minutes\n    $now = time();\n    if (abs($now - intval($timestamp)) > OPENCLAW_BRIDGE_TIMESTAMP_TOLERANCE) {\n        return new WP_Error(\n            'openclaw_expired',\n            'Request timestamp outside tolerance window.',\n            ['status' => 401]\n        );\n    }\n\n    // Reconstruct the signed payload\n    $method = $request->get_method();\n    $path = $request->get_route();\n    $body = $request->get_body();\n    $body_hash = hash('sha256', $body ?: '');\n    $payload = \"{$timestamp}:{$method}:{$path}:{$body_hash}\";\n\n    // Compute expected signature\n    $expected = hash_hmac('sha256', $payload, OPENCLAW_BRIDGE_SECRET);\n\n    // Constant-time comparison to prevent timing attacks\n    if (!hash_equals($expected, $signature)) {\n        error_log(\"[OpenClaw Bridge] HMAC verification failed from \" . $_SERVER['REMOTE_ADDR']);\n        return new WP_Error(\n            'openclaw_invalid_signature',\n            'HMAC signature verification failed.',\n            ['status' => 403]\n        );\n    }\n\n    return true;\n}\n\n/**\n * WP REST permission callback using HMAC verification.\n */\nfunction openclaw_hmac_permission(WP_REST_Request $request) {\n    $result = openclaw_verify_hmac($request);\n    if (is_wp_error($result)) {\n        return $result;\n    }\n    return true;\n}\n\n// \u2500\u2500\u2500 REST API ENDPOINTS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nadd_action('rest_api_init', function () {\n\n    // GET /openclaw/v1/subscription/status?email=customer@example.com\n    // Returns subscription tier and fleet access limits for a customer.\n    register_rest_route(OPENCLAW_BRIDGE_NAMESPACE, '/subscription/status', [\n        'methods' => 'GET',\n        'callback' => 'openclaw_get_subscription_status',\n        'permission_callback' => 'openclaw_hmac_permission',\n        'args' => [\n            'email' => [\n                'required' => true,\n                'type' => 'string',\n                'sanitize_callback' => 'sanitize_email',\n                'validate_callback' => function ($value) {\n                    return is_email($value);\n                },\n            ],\n        ],\n    ]);\n\n    // GET /openclaw/v1/subscription/all-active\n    // Returns all active subscriptions with their fleet access profiles.\n    // Used by dispatcher on startup to build the customer access map.\n    register_rest_route(OPENCLAW_BRIDGE_NAMESPACE, '/subscription/all-active', [\n        'methods' => 'GET',\n        'callback' => 'openclaw_get_all_active_subscriptions',\n        'permission_callback' => 'openclaw_hmac_permission',\n    ]);\n\n    // POST /openclaw/v1/fleet/health\n    // Fleet reports its status. WordPress stores it for the customer dashboard.\n    register_rest_route(OPENCLAW_BRIDGE_NAMESPACE, '/fleet/health', [\n        'methods' => 'POST',\n        'callback' => 'openclaw_receive_fleet_health',\n        'permission_callback' => 'openclaw_hmac_permission',\n    ]);\n\n    // GET /openclaw/v1/bridge/verify\n    // Health check \u2014 confirms bridge plugin is active and auth works.\n    register_rest_route(OPENCLAW_BRIDGE_NAMESPACE, '/bridge/verify', [\n        'methods' => 'GET',\n        'callback' => function () {\n            return new WP_REST_Response([\n                'ok' => true,\n                'version' => OPENCLAW_BRIDGE_VERSION,\n                'woocommerce' => class_exists('WooCommerce'),\n                'subscriptions' => class_exists('WC_Subscriptions'),\n            ], 200);\n        },\n        'permission_callback' => 'openclaw_hmac_permission',\n    ]);\n\n    // POST /openclaw/v1/bridge/config\n    // Set OpenClaw configuration options (HMAC-authenticated).\n    // Allows fleet to configure Convex URLs and dashboard URL remotely.\n    register_rest_route(OPENCLAW_BRIDGE_NAMESPACE, '/bridge/config', [\n        'methods' => 'POST',\n        'callback' => function (WP_REST_Request $request) {\n            $data = $request->get_json_params();\n            $allowed_keys = [\n                'openclaw_convex_site_url',\n                'openclaw_convex_api_token',\n                'openclaw_dashboard_url',\n            ];\n            $updated = [];\n            foreach ($allowed_keys as $key) {\n                if (isset($data[$key])) {\n                    update_option($key, sanitize_text_field($data[$key]), false);\n                    $updated[] = $key;\n                }\n            }\n            return new WP_REST_Response([\n                'ok' => true,\n                'updated' => $updated,\n            ], 200);\n        },\n        'permission_callback' => 'openclaw_hmac_permission',\n    ]);\n\n    // GET /openclaw/v1/bridge/config\n    // Read current OpenClaw configuration (HMAC-authenticated).\n    register_rest_route(OPENCLAW_BRIDGE_NAMESPACE, '/bridge/config', [\n        'methods' => 'GET',\n        'callback' => function () {\n            return new WP_REST_Response([\n                'openclaw_convex_site_url' => get_option('openclaw_convex_site_url', ''),\n                'openclaw_convex_api_token' => get_option('openclaw_convex_api_token') ? '***SET***' : '',\n                'openclaw_dashboard_url' => get_option('openclaw_dashboard_url', ''),\n            ], 200);\n        },\n        'permission_callback' => 'openclaw_hmac_permission',\n    ]);\n});\n\n// \u2500\u2500\u2500 ENDPOINT HANDLERS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/**\n * GET /openclaw/v1/subscription/status?email=customer@example.com\n */\nfunction openclaw_get_subscription_status(WP_REST_Request $request): WP_REST_Response {\n    $email = $request->get_param('email');\n\n    // Find customer by email\n    $customer = get_user_by('email', $email);\n    if (!$customer) {\n        return new WP_REST_Response([\n            'status' => 'none',\n            'message' => 'No customer found with this email.',\n        ], 200); // 200 not 404 \u2014 \"no subscription\" is a valid response, not an error\n    }\n\n    // Get active subscriptions for this customer\n    if (!function_exists('wcs_get_users_subscriptions')) {\n        return new WP_REST_Response([\n            'error' => 'WooCommerce Subscriptions not active.',\n        ], 503);\n    }\n\n    $subscriptions = wcs_get_users_subscriptions($customer->ID);\n    $active = null;\n\n    foreach ($subscriptions as $sub) {\n        if ($sub->has_status(['active', 'pending-cancel'])) {\n            $active = $sub;\n            break; // Use the first active subscription\n        }\n    }\n\n    if (!$active) {\n        return new WP_REST_Response([\n            'status' => 'inactive',\n            'customer_id' => $customer->ID,\n            'email' => $email,\n        ], 200);\n    }\n\n    // Get the subscription product and its OpenClaw meta\n    $items = $active->get_items();\n    $product = null;\n    foreach ($items as $item) {\n        $product = $item->get_product();\n        break;\n    }\n\n    $tier = $product ? get_post_meta($product->get_id(), '_openclaw_tier', true) : 'unknown';\n    $max_agents = $product ? intval(get_post_meta($product->get_id(), '_openclaw_max_agents', true)) : 0;\n    $max_tasks = $product ? intval(get_post_meta($product->get_id(), '_openclaw_max_tasks_monthly', true)) : 0;\n\n    return new WP_REST_Response([\n        'status' => $active->get_status(), // 'active' or 'pending-cancel'\n        'customer_id' => $customer->ID,\n        'email' => $email,\n        'subscription_id' => $active->get_id(),\n        'tier' => $tier,\n        'fleet_access' => [\n            'max_agents' => $max_agents,\n            'max_tasks_monthly' => $max_tasks,\n        ],\n        'current_period_end' => $active->get_date('next_payment'),\n        'created' => $active->get_date('start'),\n    ], 200);\n}\n\n/**\n * GET /openclaw/v1/subscription/all-active\n */\nfunction openclaw_get_all_active_subscriptions(WP_REST_Request $request): WP_REST_Response {\n    if (!function_exists('wcs_get_subscriptions')) {\n        return new WP_REST_Response(['error' => 'WooCommerce Subscriptions not active.'], 503);\n    }\n\n    $subscriptions = wcs_get_subscriptions([\n        'subscription_status' => ['active', 'pending-cancel'],\n        'subscriptions_per_page' => 100,\n    ]);\n\n    $results = [];\n    foreach ($subscriptions as $sub) {\n        $customer = $sub->get_user();\n        $items = $sub->get_items();\n        $product = null;\n        foreach ($items as $item) {\n            $product = $item->get_product();\n            break;\n        }\n\n        $tier = $product ? get_post_meta($product->get_id(), '_openclaw_tier', true) : 'unknown';\n        $max_agents = $product ? intval(get_post_meta($product->get_id(), '_openclaw_max_agents', true)) : 0;\n        $max_tasks = $product ? intval(get_post_meta($product->get_id(), '_openclaw_max_tasks_monthly', true)) : 0;\n\n        $results[] = [\n            'customer_id' => $customer ? $customer->ID : null,\n            'email' => $customer ? $customer->user_email : null,\n            'subscription_id' => $sub->get_id(),\n            'status' => $sub->get_status(),\n            'tier' => $tier,\n            'fleet_access' => [\n                'max_agents' => $max_agents,\n                'max_tasks_monthly' => $max_tasks,\n            ],\n            'current_period_end' => $sub->get_date('next_payment'),\n        ];\n    }\n\n    return new WP_REST_Response([\n        'count' => count($results),\n        'subscriptions' => $results,\n    ], 200);\n}\n\n/**\n * POST /openclaw/v1/fleet/health\n * Receives fleet health status and stores it as a transient for the customer dashboard.\n */\nfunction openclaw_receive_fleet_health(WP_REST_Request $request): WP_REST_Response {\n    $data = $request->get_json_params();\n\n    // Store as WordPress transient (expires after 10 minutes)\n    set_transient('openclaw_fleet_health', [\n        'received_at' => current_time('mysql'),\n        'agents_active' => $data['agents_active'] ?? 0,\n        'agents_total' => $data['agents_total'] ?? 0,\n        'tasks_pending' => $data['tasks_pending'] ?? 0,\n        'fleet_cost_today' => $data['fleet_cost_today'] ?? 0,\n        'breakers_tripped' => $data['breakers_tripped'] ?? [],\n    ], 600);\n\n    return new WP_REST_Response(['ok' => true], 200);\n}\n\n// \u2500\u2500\u2500 ORDER FULFILLMENT ENDPOINTS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nadd_action('rest_api_init', function () {\n\n    // POST /openclaw/v1/orders/fulfill\n    // Called by fleet/dispatcher when an order deliverable is ready.\n    // Marks WC order as completed and stores deliverable URL.\n    register_rest_route(OPENCLAW_BRIDGE_NAMESPACE, '/orders/fulfill', [\n        'methods' => 'POST',\n        'callback' => 'openclaw_fulfill_order',\n        'permission_callback' => 'openclaw_hmac_permission',\n    ]);\n\n});\n\n/**\n * POST /openclaw/v1/orders/fulfill\n * Marks a WooCommerce order as completed and attaches deliverable metadata.\n */\nfunction openclaw_fulfill_order(WP_REST_Request $request): WP_REST_Response {\n    $data = $request->get_json_params();\n\n    $wc_order_id = $data['wcOrderId'] ?? null;\n    $deliverable_url = $data['deliverableUrl'] ?? null;\n\n    if (!$wc_order_id) {\n        return new WP_REST_Response(['error' => 'Missing wcOrderId'], 400);\n    }\n\n    $order = wc_get_order($wc_order_id);\n    if (!$order) {\n        return new WP_REST_Response(['error' => 'WC order not found'], 404);\n    }\n\n    // Store deliverable URL as order meta\n    if ($deliverable_url) {\n        $order->update_meta_data('_openclaw_deliverable_url', sanitize_url($deliverable_url));\n    }\n\n    // Add order note\n    $order->add_order_note(\n        sprintf(\n            'OpenClaw order fulfilled.%s',\n            $deliverable_url ? \" Deliverable: {$deliverable_url}\" : ''\n        )\n    );\n\n    // Mark as completed\n    $order->set_status('completed', 'Fulfilled by OpenClaw fleet.');\n    $order->save();\n\n    return new WP_REST_Response(['ok' => true, 'wcOrderId' => $wc_order_id], 200);\n}\n\n// \u2500\u2500\u2500 WC PAYMENT COMPLETE \u2192 CONVEX WEBHOOK \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// When a customer pays for an order, notify Convex to create the order\n// record and generate an access token for the intake form.\n\n// Convex site URL \u2014 set in wp-config.php OR as WordPress options:\n// define('OPENCLAW_CONVEX_SITE_URL', 'https://valuable-partridge-851.convex.site');\n// define('OPENCLAW_CONVEX_API_TOKEN', 'your-convex-api-token');\n// Fallback: get_option('openclaw_convex_site_url') / get_option('openclaw_convex_api_token')\n\nadd_action('woocommerce_payment_complete', function ($order_id) {\n    $convex_url = defined('OPENCLAW_CONVEX_SITE_URL') ? OPENCLAW_CONVEX_SITE_URL : get_option('openclaw_convex_site_url');\n    $convex_token = defined('OPENCLAW_CONVEX_API_TOKEN') ? OPENCLAW_CONVEX_API_TOKEN : get_option('openclaw_convex_api_token');\n\n    if (!$convex_url || !$convex_token) {\n        error_log(\"[OpenClaw Bridge] CONVEX_SITE_URL or CONVEX_API_TOKEN not configured \u2014 skipping order webhook for #{$order_id}\");\n        return;\n    }\n\n    $order = wc_get_order($order_id);\n    if (!$order) {\n        error_log(\"[OpenClaw Bridge] Cannot load WC order #{$order_id}\");\n        return;\n    }\n\n    $customer_email = $order->get_billing_email();\n    $customer_name = trim($order->get_billing_first_name() . ' ' . $order->get_billing_last_name());\n\n    // Process each line item that has OpenClaw agent metadata\n    foreach ($order->get_items() as $item) {\n        $product = $item->get_product();\n        if (!$product) continue;\n\n        $product_id = $product->get_id();\n        // Check for OpenClaw agent mapping on this product\n        $agent_id = get_post_meta($product_id, '_openclaw_agent_id', true);\n        if (!$agent_id) {\n            // Not an OpenClaw-fulfillable product \u2014 skip\n            continue;\n        }\n\n        // Get parent product ID for variations\n        $wc_product_id = $product->is_type('variation')\n            ? $product->get_parent_id()\n            : $product_id;\n        $wc_variation_id = $product->is_type('variation')\n            ? $product_id\n            : null;\n\n        $line_total = intval(round($item->get_total() * 100)); // Convert to cents\n\n        $payload = [\n            'wcOrderId' => intval($order_id),\n            'wcProductId' => intval($wc_product_id),\n            'customerEmail' => $customer_email,\n            'customerName' => $customer_name,\n            'totalAmount' => $line_total,\n            'currency' => $order->get_currency(),\n            'tenantId' => 'localcatalyst',\n        ];\n\n        if ($wc_variation_id) {\n            $payload['wcVariationId'] = intval($wc_variation_id);\n        }\n\n        // POST to Convex /orders/webhook with Bearer token auth\n        $response = wp_remote_post(rtrim($convex_url, '/') . '/orders/webhook', [\n            'body' => json_encode($payload),\n            'headers' => [\n                'Content-Type' => 'application/json',\n                'Authorization' => 'Bearer ' . $convex_token,\n            ],\n            'timeout' => 15,\n        ]);\n\n        if (is_wp_error($response)) {\n            error_log(\"[OpenClaw Bridge] Convex webhook failed for order #{$order_id}, product #{$wc_product_id}: \" . $response->get_error_message());\n            $order->add_order_note(\"OpenClaw: Failed to create intake form \u2014 {$response->get_error_message()}\");\n            continue;\n        }\n\n        $resp_body = json_decode(wp_remote_retrieve_body($response), true);\n        $resp_code = wp_remote_retrieve_response_code($response);\n\n        if ($resp_code !== 200 || empty($resp_body['accessToken'])) {\n            $err = $resp_body['error'] ?? \"HTTP {$resp_code}\";\n            error_log(\"[OpenClaw Bridge] Convex webhook non-200 for order #{$order_id}: {$err}\");\n            $order->add_order_note(\"OpenClaw: Webhook error \u2014 {$err}\");\n            continue;\n        }\n\n        // Store the access token for redirect on thank-you page\n        $order->update_meta_data('_openclaw_access_token', $resp_body['accessToken']);\n        $order->update_meta_data('_openclaw_product_slug', $resp_body['productSlug'] ?? '');\n        $order->update_meta_data('_openclaw_order_id', $resp_body['orderId'] ?? '');\n        $order->save();\n\n        $order->add_order_note(\n            sprintf('OpenClaw: Intake form ready for %s (product %d).', $resp_body['productSlug'] ?? 'unknown', $wc_product_id)\n        );\n    }\n}, 10, 1);\n\n// \u2500\u2500\u2500 WC THANK-YOU PAGE REDIRECT \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// After payment, redirect customer to the intake form in the dashboard.\n\nadd_action('woocommerce_thankyou', function ($order_id) {\n    $order = wc_get_order($order_id);\n    if (!$order) return;\n\n    $access_token = $order->get_meta('_openclaw_access_token');\n    if (!$access_token || $access_token === 'EXISTING_ORDER') return;\n\n    $product_slug = $order->get_meta('_openclaw_product_slug');\n\n    // Dashboard intake form URL \u2014 wp-config.php constant or WP option\n    $dashboard_url = defined('OPENCLAW_DASHBOARD_URL')\n        ? OPENCLAW_DASHBOARD_URL\n        : (get_option('openclaw_dashboard_url') ?: 'https://dashboard.localcatalyst.com');\n\n    $intake_url = rtrim($dashboard_url, '/') . \"/intake/{$order_id}?token=\" . urlencode($access_token);\n\n    // Output a redirect notice + auto-redirect after 5 seconds\n    echo '<div class=\"openclaw-intake-notice\" style=\"margin: 20px 0; padding: 20px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; text-align: center;\">';\n    echo '<h3 style=\"margin: 0 0 10px;\">Almost Done! Complete Your Intake Form</h3>';\n    echo '<p>To get started on your order, please fill out a quick intake form with your business details.</p>';\n    echo '<a href=\"' . esc_url($intake_url) . '\" style=\"display: inline-block; padding: 12px 24px; background: #0ea5e9; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;\">Complete Intake Form &rarr;</a>';\n    echo '<p style=\"margin-top: 10px; font-size: 0.85em; color: #64748b;\">You\\'ll be redirected automatically in 5 seconds...</p>';\n    echo '</div>';\n    echo '<script>setTimeout(function(){ window.location.href = \"' . esc_js($intake_url) . '\"; }, 5000);</script>';\n}, 5);\n\n// \u2500\u2500\u2500 SUBSCRIPTION CHANGE NOTIFICATIONS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// When a subscription status changes, notify the fleet dispatcher so it\n// can update customer access immediately.\n\nadd_action('woocommerce_subscription_status_updated', function ($subscription, $new_status, $old_status) {\n    $fleet_webhook_url = defined('OPENCLAW_FLEET_WEBHOOK_URL')\n        ? OPENCLAW_FLEET_WEBHOOK_URL\n        : null;\n\n    if (!$fleet_webhook_url) {\n        return; // Fleet webhook not configured\n    }\n\n    $customer = $subscription->get_user();\n    $items = $subscription->get_items();\n    $product = null;\n    foreach ($items as $item) {\n        $product = $item->get_product();\n        break;\n    }\n\n    $tier = $product ? get_post_meta($product->get_id(), '_openclaw_tier', true) : 'unknown';\n\n    $body = json_encode([\n        'event' => 'subscription.status_changed',\n        'customer_email' => $customer ? $customer->user_email : null,\n        'customer_id' => $customer ? $customer->ID : null,\n        'subscription_id' => $subscription->get_id(),\n        'old_status' => $old_status,\n        'new_status' => $new_status,\n        'tier' => $tier,\n        'timestamp' => time(),\n    ]);\n\n    // Sign the outbound webhook with HMAC\n    $timestamp = time();\n    $body_hash = hash('sha256', $body);\n    $payload = \"{$timestamp}:POST:/openclaw/subscription-event:{$body_hash}\";\n    $signature = hash_hmac('sha256', $payload, OPENCLAW_BRIDGE_SECRET);\n\n    // Fire-and-forget POST to fleet\n    wp_remote_post($fleet_webhook_url, [\n        'body' => $body,\n        'headers' => [\n            'Content-Type' => 'application/json',\n            'X-OpenClaw-Timestamp' => $timestamp,\n            'X-OpenClaw-Signature' => $signature,\n        ],\n        'timeout' => 5,\n        'blocking' => false, // Don't wait for response\n    ]);\n}, 10, 3);\n"